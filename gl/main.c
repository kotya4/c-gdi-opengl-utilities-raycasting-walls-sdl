#include <windows.h>
#include <gl/gl.h>
#include <gl/glu.h>
#include <stdio.h>
#include <math.h>
#include <stdbool.h>
#include "ext.h"



LRESULT
CALLBACK    WndProc         (HWND hwnd, UINT message, WPARAM wParam, LPARAM lParam);
HWND        init_window(HINSTANCE hInstance, int x, int y, int w, int h,  const char *title);
int        init_gl    (HWND hwnd, HDC *hdc, HGLRC *hrc);
void        kill_gl   (HWND hwnd, HDC hdc, HGLRC hrc);
WPARAM      Run             (DWORD tpsec);
void        setup            ();
void        render            ();
void        update          (DWORD e);
void        on_window_resize    (WORD w, WORD h);
void        LoadTextures    ();
void        KillFont        ();
void        BuildFont       ();
void        renderTextCustom        (const char *fmt, ...);
void        SetMouseToCenter();


// window

typedef struct Window {
  int width;
  int height;
  bool focused;
} window_t;

// texture
GLuint      tex;
// text
HFONT       Font;
GLuint      FontBase;
// keyboard
BOOL        Keys [256];
// mouse
UINT        MousePosX = 0;
UINT        MousePosY = 0;
BOOL        MouseClickedLB;
BOOL        MouseClickedRB;

float heading = 0;
float xpos = 0;
float ypos = 1.2f;
float zpos = 10;
float walk_speed = 0.005f;
float view_speed = 0.015f;
GLfloat	yrot = 0;
GLfloat walkbias = 0;
GLfloat walkbiasangle = 0;
GLfloat lookupdown = 0.0f;



void
SetMouseToCenter () {
    // POINT p;
    // p.x = p.y = 0;
    // ClientToScreen(hwnd, &p);
    // p.x += WindowWidth  / 2;
    // p.y += WindowHeight / 2;
    // SetCursorPos(p.x, p.y);
    // MousePosX = WindowWidth  / 2;
    // MousePosY = WindowHeight / 2;
}


int
EnableGLExtensions (  ) {

}


int WINAPI
WinMain ( HINSTANCE hInstance, HINSTANCE hPrevInstance, LPSTR lpCmdLine, int nCmdShow ) {
  HWND hwnd = init_window ( hInstance, CW_USEDEFAULT, CW_USEDEFAULT, 400, 400, "gl" );
  if ( hwnd == NULL ) {
    printf ( "init_window: window handler cannot be created" );
    return -1;
  }
    
  ShowWindow ( hwnd, SW_NORMAL );
  
  HGLRC hrc;
  HDC hdc;
  init_gl ( hwnd, &hdc, &hrc );

  EXT_load ();

  glClearColor ( 1.f, .2f, .5f, 0.f );
  glEnableClientState ( GL_VERTEX_ARRAY );
  glEnableClientState ( GL_COLOR_ARRAY );
  
  MSG msg;
  memset ( &msg, 0, sizeof MSG );

  int oldtime = GetTickCount ();
  while ( msg.message != WM_QUIT ) {
      if ( PeekMessage ( &msg, 0, 0, 0, PM_REMOVE ) ) {
        TranslateMessage ( &msg );
        DispatchMessage ( &msg );
      }
      const int curtime = GetTickCount ();
      const int elapsed = curtime - oldtime;
      oldtime = curtime;
      
      if ( window.focused ) {
        update ( elapsed );
        render ( hdc );
      }
  }
  
  // KillFont();
  
  kill_gl ( hwnd, hdc, hrc );
  kill_window ( hwnd );
  
  return msg.wParam;
}


void
setup () {
  
    
  // LoadTextures();
  // BuildFont();
  
  // ShowCursor ( FALSE );
  // SetMouseToCenter ();
  
    

    //glEnable(GL_CULL_FACE);

    // glEnable(GL_TEXTURE_2D);							// Enable Texture Mapping
	//glDisable(GL_BLEND);
	// glEnable(GL_DEPTH_TEST);							// Enables Depth Testing
	// glBlendFunc(GL_SRC_ALPHA,GL_ONE);					// Set The Blending Function For Translucency
	glClearColor(1.f, .2f, .5f, 0.f);				// This Will Clear The Background Color To Black
	// glClearDepth(1.0);									// Enables Clearing Of The Depth Buffer
	// glDepthFunc(GL_LESS);								// The Type Of Depth Test To Do
	// glShadeModel(GL_SMOOTH);							// Enables Smooth Color Shading
	// glHint(GL_PERSPECTIVE_CORRECTION_HINT, GL_NICEST);	// Really Nice Perspective Calculations

    //glEnable(GL_BLEND);
    //glEnable(GL_POLYGON_SMOOTH);
    //glHint(GL_POLYGON_SMOOTH_HINT, GL_NICEST);

  glEnableClientState(GL_VERTEX_ARRAY);
  glEnableClientState(GL_COLOR_ARRAY);
    //glEnableClientState(GL_TEXTURE_COORD_ARRAY);


    
}

void
render ( HDC hdc ) {
   glClear ( GL_COLOR_BUFFER_BIT ); //| GL_DEPTH_BUFFER_BIT);

	// GLfloat xtrans = -xpos;
	// GLfloat ztrans = -zpos;
	// GLfloat ytrans = -ypos - walkbias;
	// GLfloat sceneroty = 360.0f - yrot;

	// glMatrixMode(GL_PROJECTION);
  // glLoadIdentity();
  // gluPerspective(70.0, WindowRatio, 0.1, 100.0);
   
  glMatrixMode(GL_MODELVIEW);
  glLoadIdentity();

  // glBindTexture( GL_TEXTURE_2D, tex );

  glPushMatrix();
  // glRotatef(lookupdown, 1.f, 0.f, 0.f);
  // glRotatef(sceneroty,  0.f, 1.f, 0.f);
  // glTranslatef(xtrans, ytrans, ztrans);
  
  const GLfloat colors[ 3 * 3 ] = {
    1.f, 0.f, 0.f,
    0.f, 1.f, 0.f,
    0.f, 0.f, 1.f
  };
  
  const GLfloat vertices[ 3 * 3 ] = {
    0.f, 0.f, 0.f,
    1.f, 0.f, 0.f,
    1.f, 1.f, 0.f
  };
  
  const int indices_length = 3;
  
  const unsigned char indices[ 3 ] = { 0, 1, 2 };
  
  glColorPointer ( 3, GL_FLOAT, 0, colors );
  glVertexPointer ( 3, GL_FLOAT, 0, vertices );
  
  glrenderElements ( GL_TRIANGLES, indices_length, GL_UNSIGNED_BYTE, indices );
      /*
      glColorPointer   (3, GL_UNSIGNED_BYTE, 0, &go.colors()[0]  );
      glVertexPointer  (3, GL_FLOAT,         0, &go.vertices()[0]);
      glTexCoordPointer(2, GL_FLOAT,         0, &go.tcoords()[0] );
      glrenderElements(GL_TRIANGLES, go.indices().size(), GL_UNSIGNED_BYTE, &go.indices()[0]);
      */
  glPopMatrix();

    //glDisableClientState(GL_VERTEX_ARRAY);
    //glDisableClientState(GL_COLOR_ARRAY);

    // glMatrixMode(GL_PROJECTION);
    // glLoadIdentity();
    // gluOrtho2D(0.0, 1, 1, 0.0);
    // glMatrixMode(GL_MODELVIEW);
    // glLoadIdentity();

	// glPushMatrix();
        // glColor3ub(255, 255, 255);
        // glRasterPos2f(0, 0.1);
        // renderTextCustom("Привет, Котя!");
    // glPopMatrix();

  SwapBuffers ( hdc );
}

void update ( DWORD e ) {
    const float piover180 = 0.0174532925f;

    const int mdx = MousePosX - WindowWidth  / 2;
    const int mdy = MousePosY - WindowHeight / 2;

    SetMouseToCenter();

    if (mdy != 0) {
        lookupdown += view_speed * mdy * e;
        if (lookupdown > 90) {
            lookupdown = 90;
        } else if (lookupdown < -90) {
            lookupdown = -90;
        }
    }

    if (mdx != 0) {
        heading -= view_speed * mdx * e;
        yrot = heading;
    }

    if (Keys['W']) {
        xpos -= sin(heading * piover180) * walk_speed * e;
        zpos -= cos(heading * piover180) * walk_speed * e;

        walkbias = sin(walkbiasangle * piover180) / 50.0f;

        if (walkbiasangle >= 359.0f) {
            walkbiasangle = 0.0f;
        } else {
            walkbiasangle += e;
        }
    }

    if (Keys['S']) {
        xpos += sin(heading * piover180) * walk_speed * e;
        zpos += cos(heading * piover180) * walk_speed * e;

        walkbias = sin(walkbiasangle * piover180) / 50.0f;

        if (walkbiasangle <= 1.0f) {
            walkbiasangle = 359.0f;
        } else {
            walkbiasangle -= e;
        }
    }

    if (Keys['A']) {
        xpos -= cos(heading * piover180) * walk_speed * e;
        zpos += sin(heading * piover180) * walk_speed * e;
    }

    if (Keys['D']) {
        xpos += cos(heading * piover180) * walk_speed * e;
        zpos -= sin(heading * piover180) * walk_speed * e;
    }

    if (Keys[VK_ESCAPE]) {
        PostQuitMessage(0);
    }
}

void LoadTextures () {
    // glGenTextures(1, &tex);
    // glBindTexture(GL_TEXTURE_2D, tex);
    // glTexParameteri(GL_TEXTURE_2D, GL_TEXTURE_MIN_FILTER, GL_NEAREST);
    // glTexParameteri(GL_TEXTURE_2D, GL_TEXTURE_MAG_FILTER, GL_NEAREST);
    // glTexParameterf(GL_TEXTURE_2D, GL_TEXTURE_WRAP_S, GL_REPEAT);
    // glTexParameterf(GL_TEXTURE_2D, GL_TEXTURE_WRAP_T, GL_REPEAT);

    // unsigned char p [] = {76,57,60,255,69,50,53,255,70,51,54,255,68,51,54,255,61,44,47,255,54,40,42,255,52,38,40,255,46,33,35,255,55,41,43,255,58,44,46,255,61,47,49,255,62,48,50,255,66,52,54,255,77,63,65,255,61,47,49,255,53,39,41,255,52,37,41,255,65,50,54,255,53,36,39,255,56,39,42,255,65,47,48,255,64,46,45,255,84,64,63,255,74,53,52,255,105,80,78,255,150,129,128,255,85,67,66,255,123,107,108,255,164,148,149,255,158,141,144,255,117,96,99,255,3,2,1,255,78,59,62,255,73,54,57,255,71,52,55,255,65,48,51,255,61,44,47,255,54,40,42,255,52,38,40,255,46,33,35,255,50,33,36,255,54,37,40,255,58,41,44,255,60,43,46,255,70,53,56,255,78,61,64,255,74,57,60,255,66,49,52,255,56,41,45,255,76,62,64,255,51,34,37,255,78,60,61,255,62,44,45,255,78,58,57,255,65,45,44,255,90,69,68,255,152,127,125,255,145,124,123,255,88,70,69,255,113,97,98,255,134,118,119,255,151,134,137,255,116,95,98,255,115,92,96,255,83,64,67,255,77,58,61,255,72,53,56,255,63,46,49,255,61,44,47,255,54,40,42,255,52,38,40,255,46,33,35,255,47,30,33,255,49,32,35,255,54,37,40,255,58,41,44,255,64,47,50,255,82,65,68,255,79,62,65,255,60,43,46,255,74,57,60,255,59,42,45,255,66,49,52,255,57,39,40,255,60,40,39,255,59,39,38,255,72,51,49,255,114,91,89,255,198,173,171,255,155,134,133,255,137,119,118,255,126,110,111,255,139,123,124,255,172,155,158,255,161,140,143,255,134,111,115,255,89,70,73,255,77,58,61,255,71,52,55,255,65,48,51,255,61,44,47,255,54,40,42,255,52,38,40,255,47,33,35,255,47,29,30,255,45,27,28,255,48,30,31,255,53,35,36,255,66,48,49,255,86,68,69,255,73,55,56,255,58,40,41,255,66,49,52,255,52,36,37,255,63,45,46,255,55,35,34,255,62,42,41,255,71,50,48,255,93,72,70,255,125,102,100,255,177,152,150,255,122,101,100,255,119,101,100,255,124,108,109,255,132,116,117,255,150,133,136,255,160,139,142,255,121,98,102,255,96,77,80,255,72,53,56,255,74,55,58,255,72,55,58,255,64,47,50,255,54,40,42,255,50,36,38,255,46,32,34,255,46,28,29,255,45,27,28,255,45,27,28,255,45,27,28,255,62,44,45,255,85,67,68,255,69,51,52,255,73,55,56,255,59,41,42,255,65,47,48,255,60,40,39,255,67,47,46,255,70,49,47,255,81,60,58,255,95,73,68,255,112,90,85,255,128,103,101,255,132,111,110,255,138,120,119,255,133,117,118,255,146,130,131,255,130,113,116,255,159,138,141,255,133,110,114,255,91,72,75,255,79,60,63,255,78,59,62,255,70,53,56,255,62,45,48,255,49,35,37,255,50,36,38,255,42,28,30,255,55,35,34,255,57,37,36,255,48,28,27,255,55,35,34,255,71,51,50,255,89,69,68,255,74,54,53,255,70,50,49,255,64,46,45,255,62,42,41,255,63,43,42,255,67,46,44,255,72,51,49,255,75,53,48,255,81,59,54,255,98,73,69,255,130,105,103,255,141,120,119,255,149,131,130,255,143,127,128,255,152,136,137,255,204,187,190,255,170,149,152,255,170,147,151,255,90,71,74,255,82,63,66,255,72,53,56,255,61,44,47,255,58,41,44,255,53,39,41,255,50,36,38,255,62,48,49,255,72,52,51,255,59,39,38,255,61,41,40,255,61,41,40,255,71,51,50,255,76,56,55,255,76,56,55,255,72,52,51,255,64,44,43,255,66,46,45,255,73,52,50,255,65,44,42,255,69,47,42,255,74,52,47,255,83,59,53,255,100,76,70,255,120,95,93,255,137,116,115,255,150,132,131,255,146,130,131,255,156,140,141,255,149,132,135,255,168,147,150,255,171,148,152,255,111,92,95,255,119,100,103,255,100,81,84,255,78,61,64,255,62,45,48,255,57,43,45,255,67,53,55,255,73,59,60,255,68,47,45,255,63,42,40,255,68,47,45,255,66,45,43,255,74,53,51,255,75,54,52,255,81,60,58,255,67,46,44,255,65,45,44,255,61,41,40,255,59,38,36,255,54,34,29,255,64,42,37,255,72,48,42,255,75,51,45,255,84,60,54,255,105,80,78,255,123,102,101,255,143,125,124,255,145,129,130,255,135,119,120,255,162,145,148,255,134,113,116,255,136,113,117,255,129,107,112,255,141,119,124,255,137,118,121,255,97,78,81,255,72,56,57,255,66,51,49,255,73,60,58,255,65,52,50,255,63,47,41,255,69,53,47,255,69,50,45,255,75,55,50,255,80,58,53,255,89,64,60,255,82,55,51,255,67,40,36,255,56,35,33,255,49,27,22,255,55,33,27,255,61,40,32,255,66,44,38,255,77,55,49,255,76,54,49,255,80,57,55,255,93,69,69,255,103,79,81,255,129,107,109,255,148,125,129,255,169,146,150,255,195,172,177,255,145,119,125,255,138,112,118,255,142,120,125,255,160,139,142,255,153,132,135,255,131,110,112,255,86,68,69,255,79,61,60,255,88,70,69,255,75,58,55,255,70,51,46,255,69,50,45,255,71,51,46,255,82,60,55,255,86,61,57,255,85,58,54,255,82,55,51,255,77,48,44,255,56,31,29,255,55,30,26,255,62,38,32,255,65,42,34,255,70,47,39,255,72,48,42,255,74,49,45,255,84,61,59,255,84,63,62,255,85,63,65,255,110,88,90,255,145,122,126,255,143,120,124,255,133,110,115,255,123,100,105,255,133,109,117,255,161,140,143,255,166,145,148,255,150,127,131,255,137,113,115,255,97,73,73,255,93,67,67,255,99,71,70,255,87,59,58,255,83,54,50,255,74,47,43,255,78,51,47,255,84,57,53,255,86,59,55,255,87,60,56,255,84,59,55,255,72,45,41,255,62,34,33,255,63,36,32,255,69,43,37,255,69,43,36,255,75,49,42,255,79,53,47,255,79,52,48,255,86,61,59,255,91,70,69,255,85,63,65,255,102,80,82,255,139,116,120,255,144,121,125,255,138,115,120,255,131,108,113,255,142,118,126,255,155,134,137,255,146,124,126,255,147,123,125,255,131,103,103,255,109,78,79,255,111,77,77,255,106,70,70,255,107,71,71,255,100,65,62,255,98,63,60,255,99,66,63,255,90,61,57,255,84,57,53,255,85,60,56,255,85,63,58,255,67,45,40,255,62,32,31,255,67,38,34,255,78,49,44,255,83,55,48,255,84,56,49,255,83,54,49,255,84,55,51,255,95,67,66,255,92,72,71,255,89,68,70,255,100,79,81,255,114,93,96,255,122,101,104,255,119,97,102,255,117,95,100,255,126,103,111,255,147,123,125,255,142,118,120,255,145,117,117,255,129,98,99,255,121,87,87,255,120,82,82,255,113,74,72,255,113,74,72,255,129,90,88,255,133,95,93,255,131,98,95,255,115,84,81,255,67,40,36,255,65,40,36,255,78,58,53,255,63,43,38,255,64,36,35,255,75,48,44,255,93,67,61,255,113,87,80,255,95,69,62,255,87,61,55,255,87,60,56,255,101,76,74,255,80,60,59,255,83,62,64,255,83,62,64,255,82,61,64,255,93,72,75,255,131,109,114,255,134,112,117,255,125,102,110,255,137,111,111,255,149,121,121,255,142,111,112,255,136,105,104,255,128,94,94,255,121,86,83,255,117,79,77,255,117,80,76,255,139,101,99,255,137,102,99,255,137,104,101,255,112,83,79,255,78,53,49,255,59,37,32,255,64,44,39,255,69,49,44,255,71,48,46,255,129,107,102,255,193,171,165,255,179,158,150,255,140,119,111,255,84,62,56,255,81,59,54,255,66,43,41,255,72,54,53,255,69,51,52,255,61,43,44,255,54,35,38,255,56,37,40,255,101,81,86,255,130,110,115,255,131,110,118,255,163,132,133,255,161,130,131,255,146,116,115,255,151,121,120,255,136,105,102,255,115,84,81,255,109,77,72,255,106,74,69,255,112,81,78,255,118,89,85,255,125,98,94,255,108,83,79,255,88,66,61,255,57,37,32,255,49,30,25,255,63,44,39,255,103,84,81,255,210,191,186,255,223,205,198,255,176,159,150,255,119,102,93,255,80,62,55,255,65,46,41,255,70,51,48,255,72,54,53,255,68,50,51,255,61,43,44,255,56,37,40,255,57,38,41,255,74,54,59,255,105,85,90,255,118,97,105,255,150,118,119,255,142,110,111,255,145,115,114,255,145,116,112,255,124,97,93,255,99,73,67,255,98,72,66,255,96,70,64,255,95,70,66,255,103,78,74,255,100,78,73,255,95,73,68,255,85,65,60,255,65,45,40,255,47,28,23,255,41,22,17,255,51,34,31,255,95,79,73,255,85,69,62,255,68,53,44,255,59,44,35,255,75,59,52,255,75,59,53,255,86,69,66,255,63,45,44,255,55,37,38,255,53,35,36,255,55,36,39,255,68,49,52,255,72,52,57,255,85,65,70,255,101,80,88,255,140,112,112,255,121,93,93,255,132,104,103,255,127,97,96,255,128,99,95,255,98,69,65,255,98,69,64,255,87,57,52,255,71,45,38,255,93,69,63,255,92,73,66,255,87,69,62,255,79,60,55,255,75,56,51,255,57,36,34,255,39,18,16,255,40,23,20,255,40,23,20,255,43,24,19,255,53,34,29,255,66,47,42,255,71,54,51,255,90,78,74,255,68,56,54,255,43,32,34,255,49,36,38,255,44,31,33,255,56,41,45,255,76,59,63,255,75,57,64,255,79,58,66,255,93,72,81,255,116,90,90,255,102,76,76,255,111,83,83,255,120,90,89,255,133,104,100,255,108,77,74,255,98,68,63,255,83,53,48,255,93,67,60,255,74,53,45,255,93,74,67,255,81,63,56,255,78,62,56,255,82,63,58,255,68,47,45,255,51,30,28,255,43,24,21,255,44,25,22,255,69,48,46,255,98,77,75,255,106,87,84,255,90,75,72,255,57,46,42,255,35,28,25,255,37,29,30,255,41,30,32,255,49,38,40,255,59,45,49,255,74,59,63,255,86,68,75,255,90,69,77,255,77,56,65,255,104,78,78,255,99,73,73,255,121,95,95,255,129,101,100,255,143,114,110,255,116,87,83,255,97,67,62,255,86,56,51,255,84,58,51,255,144,123,115,255,168,149,142,255,43,25,18,255,53,37,31,255,69,50,45,255,74,53,51,255,71,48,46,255,55,34,33,255,51,27,27,255,63,39,39,255,75,54,53,255,63,45,44,255,54,41,39,255,39,30,27,255,33,26,23,255,36,25,27,255,46,35,37,255,61,48,50,255,57,43,47,255,81,66,70,255,98,80,87,255,100,82,89,255,112,93,102,255,111,87,87,255,117,93,93,255,127,101,101,255,145,117,116,255,156,129,125,255,124,95,91,255,100,71,66,255,104,75,70,255,143,117,110,255,255,234,226,255,188,169,162,255,28,10,3,255,46,30,24,255,57,38,33,255,64,43,41,255,67,44,42,255,66,40,40,255,61,35,35,255,66,40,40,255,65,41,41,255,64,44,43,255,51,38,36,255,34,27,24,255,37,30,27,255,39,26,28,255,42,29,31,255,51,38,40,255,55,40,44,255,78,63,67,255,93,77,84,255,92,76,83,255,101,84,93,255,124,100,100,255,128,104,104,255,126,102,102,255,174,149,147,255,160,135,131,255,133,106,102,255,113,84,79,255,105,76,71,255,187,161,154,255,253,232,224,255,93,74,67,255,41,23,16,255,50,34,28,255,57,38,33,255,63,42,40,255,75,50,48,255,78,48,47,255,76,46,45,255,76,46,45,255,76,46,45,255,74,51,49,255,58,39,36,255,42,30,26,255,35,23,21,255,37,23,25,255,40,26,28,255,46,32,34,255,55,40,44,255,76,61,65,255,77,63,69,255,89,75,81,255,103,88,96,255,114,93,92,255,116,95,94,255,139,115,115,255,133,110,108,255,121,96,92,255,138,111,107,255,122,96,90,255,100,74,68,255,129,103,96,255,107,86,78,255,53,34,27,255,62,44,37,255,53,37,31,255,59,40,35,255,65,44,42,255,77,52,50,255,87,57,52,255,93,61,56,255,97,65,60,255,99,67,62,255,89,59,54,255,80,54,48,255,70,48,42,255,48,27,25,255,45,28,31,255,48,31,34,255,51,34,37,255,55,40,44,255,59,45,49,255,75,61,67,255,100,88,94,255,100,87,95,255,121,100,99,255,126,105,104,255,130,109,108,255,181,158,156,255,148,126,121,255,137,112,108,255,142,116,110,255,119,93,87,255,115,89,82,255,101,80,72,255,88,69,62,255,74,56,49,255,67,51,45,255,67,48,43,255,69,48,46,255,80,55,51,255,95,66,57,255,105,74,65,255,116,80,72,255,120,83,75,255,120,81,73,255,116,80,72,255,110,77,68,255,79,49,44,255,76,57,60,255,78,59,62,255,62,45,48,255,49,34,38,255,57,43,47,255,69,57,63,255,81,69,75,255,86,75,83,255,123,103,102,255,126,105,104,255,160,139,138,255,187,164,162,255,144,122,117,255,138,113,109,255,138,114,108,255,124,98,92,255,112,86,79,255,88,67,59,255,86,67,60,255,77,59,52,255,67,51,45,255,68,49,44,255,73,52,50,255,88,64,58,255,101,75,59,255,114,83,68,255,122,87,73,255,129,87,74,255,146,102,89,255,161,117,104,255,174,132,119,255,166,130,122,255,164,145,148,255,137,118,121,255,97,80,83,255,76,61,65,255,65,51,55,255,54,42,48,255,62,50,56,255,74,63,71,255,117,95,97,255,131,109,111,255,136,114,116,255,133,111,113,255,130,108,110,255,129,107,109,255,135,113,115,255,139,115,115,255,102,80,75,255,76,57,54,255,69,51,50,255,52,36,37,255,54,38,39,255,63,45,44,255,75,56,53,255,81,59,53,255,103,77,61,255,120,87,72,255,127,88,73,255,137,92,78,255,154,110,97,255,167,126,117,255,200,164,156,255,191,160,157,255,144,123,126,255,135,114,117,255,125,104,107,255,177,156,159,255,116,95,98,255,83,64,67,255,75,55,60,255,75,55,60,255,125,102,106,255,123,100,104,255,127,104,108,255,127,104,108,255,131,108,112,255,131,108,112,255,129,106,110,255,121,99,101,255,101,80,78,255,76,56,55,255,63,47,48,255,58,44,46,255,54,40,42,255,55,37,38,255,63,44,41,255,75,53,48,255,95,69,57,255,113,84,70,255,137,100,86,255,155,113,101,255,167,125,113,255,197,161,153,255,169,138,135,255,140,114,114,255,145,122,126,255,139,116,120,255,172,149,153,255,147,124,128,255,107,84,88,255,149,126,130,255,156,133,137,255,115,92,96,255,128,105,109,255,106,83,87,255,130,107,111,255,123,100,104,255,123,100,104,255,122,99,103,255,128,105,109,255,128,106,108,255,97,76,74,255,73,55,56,255,79,62,65,255,69,54,58,255,63,49,51,255,52,36,37,255,52,32,31,255,64,43,41,255,83,59,53,255,105,77,70,255,143,110,101,255,169,132,124,255,182,146,140,255,171,138,135,255,152,124,124,255,132,108,110,255,136,113,117,255,143,120,124,255,146,123,127,255,120,97,101,255,149,126,130,255,173,150,154,255,133,110,114,255,137,114,118,255,128,105,109,255,117,94,98,255,127,104,108,255,120,97,101,255,125,102,106,255,123,100,104,255,124,101,105,255,122,99,103,255,104,83,85,255,87,68,71,255,81,66,70,255,82,68,74,255,81,67,71,255,73,56,59,255,59,41,42,255,63,42,44,255,68,46,48,255,109,85,85,255,145,115,114,255,148,117,114,255,150,119,118,255,151,123,123,255,130,107,111,255,128,105,109,255,120,97,101,255,134,111,115,255,136,113,117,255,141,118,122,255,138,115,119,255,116,93,97,255,132,109,113,255,146,123,127,255,119,96,100,255,111,88,92,255,92,69,73,255,116,93,97,255,124,101,105,255,125,102,106,255,130,107,111,255,127,104,108,255,108,87,90,255,90,73,77,255,77,60,69,255,85,70,78,255,97,82,90,255,94,78,85,255,78,59,62,255,78,57,60,255,87,66,74,255,129,106,111,255,142,118,120,255,149,123,123,255,149,125,127,255,125,102,106,255,122,100,105,255,116,94,99,255,126,103,107,255,136,113,117,255,147,124,128,255,110,87,91,255,108,85,89,255,96,73,77,255,147,124,128,255,148,125,129,255,104,81,85,255,90,67,71,255,103,80,84,255,128,105,109,255,127,104,108,255,128,105,109,255,124,101,105,255,118,95,99,255,119,99,104,255,114,96,103,255,88,72,83,255,94,80,92,255,95,81,92,255,89,72,81,255,89,72,76,255,70,49,57,255,86,62,74,255,119,96,104,255,131,110,113,255,156,135,138,255,137,116,118,255,122,101,104,255,132,110,115,255,130,108,113,255,148,125,129,255,142,119,123,255,134,111,115,255,105,82,86,255,139,116,120,255,134,111,115,255,107,84,88,255,102,79,83,255,105,82,86,255,86,63,67,255,117,94,98,255,125,102,106,255,120,97,101,255,111,88,92,255,116,93,97,255,116,95,98,255,107,86,94,255,115,98,107,255,89,72,85,255,98,83,97,255,96,82,94,255,104,88,99,255,98,80,87,255,78,57,66,255,84,58,72,255,129,104,114,255,140,118,123,255,139,118,120,255,123,103,102,255,126,105,107,255,123,100,104,255,143,120,125,255,145,122,126,255,132,109,113,255,136,113,117,255,151,128,132,255,162,139,143,255,114,91,95,255,97,74,78,255,121,98,102,255,117,94,98,255,90,67,71,255,136,113,117,255,146,123,127,255,125,102,106,255,109,86,90,255,124,101,105,255,114,93,96,255,106,88,95,255,115,98,107,255,97,80,93,255,103,90,104,255,107,92,106,255,108,92,103,255,89,72,81,255,74,53,62,255,97,68,83,255,149,124,134,255,123,102,105,255,103,82,84,255,123,103,102,255,144,124,123,255,131,109,111,255,135,110,114,255,142,119,123,255,140,117,121,255,138,115,119,255,152,129,133,255,170,147,151,255,134,111,115,255,133,110,114,255,105,82,86,255};

    // glTexImage2D(GL_TEXTURE_2D, 0, GL_RGBA, 32, 32, 0, GL_BGRA_EXT, GL_UNSIGNED_BYTE, p);
}


// automaticly called after window creation
void
on_window_resize ( int w, int h ) {
    
    if ( h == 0 ) h = 1;

    glViewport ( 0, 0, (GLsizei)w, (GLsizei)h );

    WindowWidth  = w;
    WindowHeight = h;
    WindowRatio  = (GLdouble)w / h;
}

WPARAM
Run ( DWORD tpsec ) {
    
}

LRESULT CALLBACK WndProc (HWND hwnd, UINT message, WPARAM wParam, LPARAM lParam) {
    switch (message) {

    // window

    case WM_CREATE:
        return 0;

    case WM_CLOSE:
        PostQuitMessage(0);
        return 0;

    case WM_DESTROY:
        return 0;

    case WM_SIZE:
        on_window_resize(LOWORD(lParam), HIWORD(lParam));
        return 0;

    case WM_SETFOCUS:
        WindowInFocus = TRUE;
        return 0;

    case WM_KILLFOCUS:
        WindowInFocus = FALSE;
        return 0;

    // keyboard

    case WM_KEYDOWN:
        Keys[wParam] = TRUE;
        if (Keys[VK_ESCAPE]) {
            PostQuitMessage(0);
        }
        return 0;

    case WM_KEYUP:
        Keys[wParam] = FALSE;
        return 0;

    // mouse

    case WM_MOUSEMOVE:
        MousePosX = LOWORD(lParam);
        MousePosY = HIWORD(lParam);
        return 0;

    case WM_LBUTTONDOWN:
        MouseClickedLB = TRUE;
        return 0;

    case WM_LBUTTONUP:
        MouseClickedLB = FALSE;
        return 0;

    case WM_RBUTTONDOWN:
        MouseClickedRB = TRUE;
        return 0;

    case WM_RBUTTONUP:
        MouseClickedRB = FALSE;
        return 0;

    // other

    default:
        return DefWindowProc(hwnd, message, wParam, lParam);
    }
}

HWND init_window ( HINSTANCE hInstance, int x, int y, int w, int h, const char* title ) {
    WNDCLASS wc;
    wc.style         = CS_OWNDC;
    wc.lpfnWndProc   = WndProc;
    wc.cbClsExtra    = 0;
    wc.cbWndExtra    = 0;
    wc.hInstance     = hInstance;
    wc.hIcon         = LoadIcon(NULL, IDI_APPLICATION);
    wc.hCursor       = LoadCursor(NULL, IDC_ARROW);
    wc.hbrBackground = (HBRUSH)GetStockObject(BLACK_BRUSH);
    wc.lpszMenuName  = NULL;
    wc.lpszClassName = "OpenGL";
    RegisterClass ( &wc );
    return CreateWindow
      ( wc.lpszClassName
      , title         
      , WS_OVERLAPPEDWINDOW | WS_VISIBLE
      , x
      , y
      , w
      , h
      , NULL
      , NULL
      , hInstance
      , NULL 
      );
}

void
kill_window ( HWND hwnd ) {
  DestroyWindow ( hwnd );
}



int
init_gl ( HWND hwnd, HDC *hdc, HGLRC *hrc ) {
  PIXELFORMATDESCRIPTOR pfd;
  ZeroMemory ( &pfd, sizeof ( pfd ) );
  pfd.nSize        = sizeof ( pfd );
  pfd.nVersion     = 1;
  pfd.dwFlags      = PFD_DRAW_TO_WINDOW | PFD_SUPPORT_OPENGL | PFD_DOUBLEBUFFER;
  pfd.iPixelType   = PFD_TYPE_RGBA;
  pfd.cColorBits   = 32;
  pfd.cDepthBits   = 24;
  pfd.cStencilBits = 8;
  pfd.iLayerType   = PFD_MAIN_PLANE;
  *hdc = GetDC ( hwnd );
  SetPixelFormat( *hdc, ChoosePixelFormat ( *hdc, &pfd ), &pfd );
  *hrc = wglCreateContext ( *hdc ); // render context
  wglMakeCurrent ( *hdc, *hrc );
  
}

void
kill_gl ( HWND hwnd, HDC hdc, HGLRC hrc ) {
  wglMakeCurrent ( NULL, NULL );
  wglDeleteContext ( hrc );
  ReleaseDC ( hwnd, hdc );
}

void BuildFont () {
    // FontBase = glGenLists(256);
    // Font = CreateFont(-12,                  // Высота фонта
            // 0,                              // Ширина фонта
            // 0,                              // Угол отношения
            // 0,                              // Угол Наклона
            // FW_THIN,                        // Ширина шрифта
            // FALSE,                          // Курсив
            // FALSE,                          // Подчеркивание
            // FALSE,                          // Перечеркивание
            // RUSSIAN_CHARSET,                // Идентификатор набора символов
            // OUT_TT_PRECIS,                  // Точность вывода
            // CLIP_DEFAULT_PRECIS,            // Точность отсечения
            // ANTIALIASED_QUALITY,            // Качество вывода
            // FF_DONTCARE|DEFAULT_PITCH,      // Семейство и Шаг
            // "Arial");                       // Имя шрифта
    // SelectObject(hdc, Font);                // Выбрать шрифт, созданный нами ( НОВОЕ )
    // wglUseFontBitmaps(hdc, 0, 256, FontBase);   // Построить 96 символов начиная с пробела ( НОВОЕ )
}

void KillFont () {
    glDeleteLists(FontBase, 256);
    DeleteObject(Font);
}

void KillTextures () {
    //glDeleteTextures(1,  tex);
}

void renderTextCustom (const char *fmt, ...) {
    char text [256];
    va_list ap;
    if (fmt == NULL) {
        return;
    }
    va_start(ap, fmt);
    vsprintf(text, fmt, ap);
    va_end(ap);
    glPushAttrib(GL_LIST_BIT);
    glListBase(FontBase);
    glCallLists(strlen(text), GL_UNSIGNED_BYTE, text);
    glPopAttrib();
}
